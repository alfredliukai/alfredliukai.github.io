<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh_CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="linux,">










<meta name="description" content="BIOS、EFI、UEFIBIOS存储在BIOS芯片中，而现在的新式电脑用的基本都是UEFI启动，早期的过渡电脑用的都是EFI启动。其实EFI或UEFI的一部分也是存储在一个芯片中，由于它们在表面形式、基本功能上和BIOS差不多，所以习惯上我们也把存储EFI/UEFI的芯片叫做EFI/UEFI BIOS芯片，EFI/UEFI也叫做EFI/UEFI BIOS，但在实际上它们和BIOS根本是不一样的，">
<meta name="keywords" content="linux">
<meta property="og:type" content="article">
<meta property="og:title" content="linux系统启动小结">
<meta property="og:url" content="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/index.html">
<meta property="og:site_name" content="昨非的个人网站">
<meta property="og:description" content="BIOS、EFI、UEFIBIOS存储在BIOS芯片中，而现在的新式电脑用的基本都是UEFI启动，早期的过渡电脑用的都是EFI启动。其实EFI或UEFI的一部分也是存储在一个芯片中，由于它们在表面形式、基本功能上和BIOS差不多，所以习惯上我们也把存储EFI/UEFI的芯片叫做EFI/UEFI BIOS芯片，EFI/UEFI也叫做EFI/UEFI BIOS，但在实际上它们和BIOS根本是不一样的，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/gpt1.png">
<meta property="og:image" content="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/gpt2.png">
<meta property="og:image" content="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/uefi1.png">
<meta property="og:image" content="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/uefi2.png">
<meta property="og:image" content="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/uefi3.png">
<meta property="og:image" content="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/uefi4.png">
<meta property="og:image" content="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/uefi5.png">
<meta property="og:updated_time" content="2021-05-24T08:59:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="linux系统启动小结">
<meta name="twitter:description" content="BIOS、EFI、UEFIBIOS存储在BIOS芯片中，而现在的新式电脑用的基本都是UEFI启动，早期的过渡电脑用的都是EFI启动。其实EFI或UEFI的一部分也是存储在一个芯片中，由于它们在表面形式、基本功能上和BIOS差不多，所以习惯上我们也把存储EFI/UEFI的芯片叫做EFI/UEFI BIOS芯片，EFI/UEFI也叫做EFI/UEFI BIOS，但在实际上它们和BIOS根本是不一样的，">
<meta name="twitter:image" content="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/gpt1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/">





  <title>linux系统启动小结 | 昨非的个人网站</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">昨非的个人网站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-标签">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-归档">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-关于">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://alfredliukai.github.io/2021/05/24/linux系统启动小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="昨非">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="昨非的个人网站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">linux系统启动小结</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-05-24T13:05:50+08:00">
                2021-05-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="BIOS、EFI、UEFI"><a href="#BIOS、EFI、UEFI" class="headerlink" title="BIOS、EFI、UEFI"></a>BIOS、EFI、UEFI</h4><p>BIOS存储在BIOS芯片中，而现在的新式电脑用的基本都是UEFI启动，早期的过渡电脑用的都是EFI启动。其实EFI或UEFI的一部分也是存储在一个芯片中，由于它们在表面形式、基本功能上和BIOS差不多，所以习惯上我们也把存储EFI/UEFI的芯片叫做EFI/UEFI BIOS芯片，EFI/UEFI也叫做EFI/UEFI BIOS，但在实际上它们和BIOS根本是不一样的，所以最好还是把后面的“BIOS”尾巴去掉为好，下面就来具体谈一下BIOS、EFI和UEFI。</p>
<p>BIOS本身是汇编语言代码，是在16位实模式下调用INT 13H中断执行的，由于x86-64是一个高度兼容的指令集，也为了迁就BIOS的16位实模式的运行环境，所以即使现在的CPU都已是64位，如果还是在BIOS启动（基本见于09年以前的主板），在开机时仍然都是在16位实模式下执行的。16位实模式直接能访问的内存只有1MB，就算你安了4G、8G或者16G还是32G内存，到了BIOS上一律只先认前1MB。在这1MB内存中，前640K称为基本内存，后面384K内存留给开机必要硬件和各类BIOS本身使用，了解了这些，下面谈一下BIOS启动计算机的具体过程。</p>
<p>当按下电源开关时，电源就开始向主板和其他设备供电，这时电压还不稳定，在早期的南北桥主板上，由主板北桥向CPU发复位信号，对CPU初始化；稳定电压后复位信号便撤掉。而对于现在的单南桥主板，则由CPU自身调整稳定电压达到初始化的目的，当电压稳定后，CPU便在系统BIOS保留的内存地址处执行跳转BIOS起始处指令，开始执行POST自检。</p>
<p>在POST自检中，BIOS只检查系统的必要核心硬件是否有问题，主要是CPU、640K基本内存、显卡是否正常，PS/2键盘控制器、系统时钟是否有错误等等。由于POST检查在显卡初始化以前，因此在这个阶段如发生错误，是无法在屏幕上显示的，不过主板上还有个报警扬声器，而且如果主板的8255外围可编程接口芯片没有损坏的话，POST报警声音一定是会出来的。可以根据报警声的不同大致判断错误所在，一般情况下，一声短“嘀”声基本代表正常启动，不同的错误则是不同的短“嘀”声和长“嘀”声组合。POST自检结束后，BIOS开始调用中断完成各种硬件初始化工作。</p>
<p>硬件初始化工作中，主要说明两点，首先经过POST检测后，电脑终于出现了开机启动画面，这就是已经检测到了显卡并完成了初始化。但是请注意，由于BIOS是在16位实模式运行，因此该画面是以VGA分辨率（640*480，纵横比4:3）显示的，因为实模式最高支持的就是VGA。以前的小14-17寸CRT显示器由于都是4:3比例，最高分辨率也比较低，因此这个开机启动画面没有什么违和感，但现在的液晶显示器基本上都是宽屏16:9的，分辨率也较高，因此在这样的显示屏下，启动画面上的一切东西显示都可以说“惨不忍睹”——图形被拉长，字体很大很模糊，可以很明显看到显示字体的锯齿。第二，BIOS只识别到由主引导记录（MBR）初始化的硬盘，之所以说明这点，是因为后续的EFI或UEFI采用了一种新的GUID磁盘分区系统（GPT）格式，这种硬盘在BIOS下是无法识别的。硬件全部初始化完毕后，接下来进入更新ESCD阶段。</p>
<p>在ESCD更新阶段中，BIOS将对存储在CMOS中和操作系统交换的硬件配置数据进行检测，如果系统硬件发生变动，则会更新该数据，否则不更新保持原状不变，ESCD检测或更新结束后，BIOS将完成最后一项工作，就是启动操作系统。</p>
<p>最后这一步中，BIOS根据CMOS中用户指定的硬件启动顺序，读取相应设备的启动或引导记录，引导相应设备上的操作系统启动，进入操作系统，此后便由操作系统接替BIOS负责硬件和软件间的相互通信。如果发现所有硬件都没有能引导操作系统的记录，则会在屏幕上显示相应错误信息，并将电脑维持在16位实模式。</p>
<p>EFI，是Extensible Firmware Interface的词头缩写，直译过来就是可扩展固件接口，它是用模块化、高级语言（主要是C语言）构建的一个小型化系统，它和BIOS一样，主要在启动过程中完成硬件初始化，但它是直接利用加载EFI驱动的方式，识别系统硬件并完成硬件初始化，彻底摒弃读各种中断执行。EFI驱动并不是直接面向CPU的代码，而是由EFI字节码编写成，EFI字节码是专用于EFI的虚拟机器指令，需要在EFI驱动运行环境DXE下解释运行，这样EFI既可以实现通配，又提供了良好的兼容。此外，EFI完全是32位或64位，摒弃16位实模式，在EFI中就可以实现处理器的最大寻址，因此可以在任何内存地址存放任何信息。另外，由于EFI的驱动开发非常简单，基于EFI的驱动模型原则上可以使EFI接触到所有硬件功能，在EFI上实现文件读写，网络浏览都是完全可能的。BIOS上的的CMOS设置程序在EFI上是作为一个个EFI程序来执行的，硬件设置是硬件设置程序、而启动管理则是另一个程序，保存CMOS又是另一个程序，虽然它们在形式的Shell上是在一起的。</p>
<p>EFI在功能上完全等同于一个轻量化的OS，但是EFI在制定时就定位到不足以成为专业OS的地位上，首先，它只是一个硬件和操作系统间的一个接口；其次，EFI不提供中断访问机制，EFI必须用轮询的方式检查并解释硬件，较OS下的驱动执行效率较低，最后，EFI只有简单的存储器管理机制，在段保护模式下只将存储器分段，所有程序都可以存取任何一段位置，不提供真实的保护服务。伴随着EFI，一种全新的GUID磁盘分区系统（GPT）被引入支持，传统MBR磁盘只能存在4个主分区，只有在创建主分区不足4个时，可以建立一个扩展分区，再在其上建立被系统识别的逻辑分区，逻辑分区也是有数量的，太多的逻辑分区会严重影响系统启动，MBR硬盘分区最大仅支持2T容量，对于现在的大容量硬盘来说也是浪费。GPT支持任意多的分区，每个分区大小原则上是无限制的，但实际上受到OS的规定限制不能做到无限，不过比MBR的2T限制是非常重要的进步。GPT的分区类型由GUID表唯一指定，基本不可能出现重复，其中的EFI系统分区可以被EFI存取，用来存取部分驱动和应用程序，虽然这原则上会使EFI系统分区变得不安全，但是一般这里放置的都是些“边缘”数据，即使其被破坏，一般也不会造成严重后果，而且也能够简单的恢复回来。</p>
<p>当EFI发展到1.1的时候，英特尔决定把EFI公之于众，于是后续的2.0吸引了众多公司加入，EFI也不再属于英特尔，而是属于了Unified EFI Form的国际组织，EFI在2.0后也遂改称为UEFI，UEFI，其中的EFI和原来是一个意思，U则是Unified（一元化、统一）的缩写，所以UEFI的意思就是“统一的可扩展固件接口”，与前身EFI相比，UEFI主要有以下改进：</p>
<p>首先，UEFI具有完整的图形驱动功能，之前的EFI虽然原则上加入了图形驱动，但为了保证EFI和BIOS的良好过渡，EFI多数还是一种类DOS界面（仍然是640<em>480VGA分辨率），只支持PS/2键盘操作（极少数支持鼠标操作），不支持USB键盘和鼠标。到了UEFI，则是拥有了完整的图形驱动，无论是PS/2还是USB键盘和鼠标，UEFI一律是支持的，而且UEFI在显卡也支持GOP VBIOS的时候，显示的设置界面是显卡高分辨率按640</em>480或1024*768显示，因此画面虽小但很清楚，但是这样会导致屏幕周围大片留黑，不过鱼和熊掌不可兼得，除非UEFI默认窗口大小也是最高分辨率</p>
<p>其次，UEFI具有一个独特的功能，安全启动，而EFI是没有安全启动的，安全启动（Secure Boot），实际上通俗的解释是叫做固件验证。开启UEFI的安全启动后，主板会根据TPM芯片（或者CPU内置的TPM）记录的硬件签名对各硬件判断，只有符合认证的硬件驱动才会被加载，而Win8以后的Windows则是在操作系统加载的过程中对硬件驱动继续查签名，符合Windows记录的硬件才能被Windows加载，这在一定程度上降低了启动型程序在操作系统启动前被预加载造成的风险，但是这也会造成系统安装变得垄断</p>
<p>无论EFI还是UEFI，都必须要有预加载环境、驱动执行环境、驱动程序等必要部分组成，为了支持部分旧设备（如在UEFI下挂载传统MBR硬盘，不支持UEFI启动的显卡在UEFI下仍然支持运行等），还需要一个CSM兼容性支持模块、EFI或UEFI都是仅支持GPT磁盘引导系统的，下面就具体谈一下EFI或UEFI启动计算机的过程。</p>
<p>一般地，预加载环境和驱动执行环境是存储在UEFI（UEFI BIOS）芯片中的，当打开电源开关时，电脑的主要部件都开始有了供电，与BIOS不同的是，UEFI预加载环境首先开始执行，负责CPU和内存（是全部容量）的初始化工作，这里如出现重要问题，电脑即使有报警喇叭也不会响，因为UEFI没有去驱动8255发声，不过预加载环境只检查CPU和内存，如果这两个主要硬件出问题，屏幕没显示可以立即确定，另外一些主板会有提供LED提示，可根据CPU或内存亮灯大致判断故障。</p>
<p>CPU和内存初始化成功后，驱动执行环境（DXE）载入，当DXE载入后，UEFI就具有了枚举并加载UEFI驱动程序的能力，在此阶段，UEFI会枚举搜索各个硬件的UEFI驱动并相继加载，完成硬件初始化工作，这相比BIOS的读中断加载速度会快的多，同样如加载显卡的UEFI驱动成功，电脑也会出现启动画面，硬件驱动全部加载完毕后，最后同BIOS一样，也得去启动操作系统。</p>
<p>在启动操作系统的阶段，同样是根据启动记录的启动顺序，转到相应设备（仅限GPT设备，如果启动传统MBR设备，则需要打开CSM支持）的引导记录，引导操作系统并进入，这里需要注意的是，UEFI在检测到无任何操作系统启动设备时，会直接进入UEFI设置页面，而不是像BIOS那样黑屏显示相关信息。</p>
<p>综上对BIOS和UEFI启动计算机过程的叙述，可以概括为：BIOS先要对CPU初始化，然后跳转到BIOS启动处进行POST自检，此过程如有严重错误，则电脑会用不同的报警声音提醒，接下来采用读中断的方式加载各种硬件，完成硬件初始化后进入操作系统启动过程；而UEFI则是运行预加载环境先直接初始化CPU和内存，CPU和内存若有问题则直接黑屏，其后启动PXE采用枚举方式搜索各种硬件并加载驱动，完成硬件初始化，之后同样进入操作系统启动过程。</p>
<p>此外，BIOS是16位汇编语言程序，只能运行在16位实模式，可访问的内存只有1MB，而UEFI是32位或64位高级语言程序（C语言程序），突破实模式限制，可以达到要求的最大寻址。</p>
<h4 id="genisoimage、mkisofs"><a href="#genisoimage、mkisofs" class="headerlink" title="genisoimage、mkisofs"></a>genisoimage、mkisofs</h4><p><strong>genisoimage</strong></p>
<p>功能说明：建立ISO 9660映像文件。  </p>
<p>常用命令：genisoimage -o imagename.iso file </p>
<p>语 法：mkisofs [-adDfhJlLNrRTvz][-print-size][-quiet][-A ][-abstract ][-b ][-biblio ][-c ][-C ][-copyright ][-hide ][-hide-joliet ][-log-file ][-m ][-M ][-o ][-p ][-P ][-sysid ][-V ][-volset ][-volset-size ][-volset-seqno ][-x ][目录或文件]  </p>
<p><strong>mkisofs</strong></p>
<p>命令: mkisofs(make iso file system)</p>
<p>功能说明：建立ISO 9660映像文件。</p>
<p>语 法：mkisofs [-adDfhJlLNrRTvz][-print-size][-quiet][-A &lt;应用程序ID&gt;][-abstract &lt;摘要文件&gt;][-b &lt;开机映像文件&gt;][-biblio ][-c &lt;开机文件名称&gt;][-C &lt;盘区编号，磁区编号&gt;][-copyright &lt;版权信息文件&gt;][-hide &lt;目录或文件名&gt;][-hide-joliet &lt;文件或目录名&gt;][-log-file &lt;记录文件&gt;][-m &lt;目录或文件名&gt;][-M &lt;开机映像文件&gt;][-o &lt;映像文件&gt;][-p &lt;数据处理人&gt;][-P &lt;光盘发行人&gt;][-sysid &lt;系统ID &gt;][-V &lt;光盘ID &gt;][-volset &lt;卷册集ID&gt;][-volset-size &lt;光盘总数&gt;][-volset-seqno &lt;卷册序号&gt;][-x &lt;目录&gt;][目录或文件]</p>
<p>补充说明：mkisofs可将指定的目录与文件做成ISO 9660格式的映像文件，以供刻录光盘。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">参 数：</span><br><span class="line">-a或--all mkisofs通常不处理备份文件。使用此参数可以把备份文件加到映像文件中。</span><br><span class="line">-A&lt;应用程序ID&gt;或-appid&lt;应用程序ID&gt; 指定光盘的应用程序ID。</span><br><span class="line">-abstract&lt;摘要文件&gt; 指定摘要文件的文件名。</span><br><span class="line">-b&lt;开机映像文件&gt;或-eltorito-boot&lt;开机映像文件&gt; 指定在制作可开机光盘时所需的开机映像文件。</span><br><span class="line">-biblio 指定ISBN文件的文件名，ISBN文件位于光盘根目录下，记录光盘的ISBN。</span><br><span class="line">-c&lt;开机文件名称&gt; 制作可开机光盘时，mkisofs会将开机映像文件中的全-eltorito-catalog&lt;开机文件名称&gt;全部内容作成一个文件。</span><br><span class="line">-C&lt;盘区编号，盘区编号&gt; 将许多节区合成一个映像文件时，必须使用此参数。</span><br><span class="line">-copyright&lt;版权信息文件&gt; 指定版权信息文件的文件名。</span><br><span class="line">-d或-omit-period 省略文件后的句号。</span><br><span class="line">-D或-disable-deep-relocation ISO 9660最多只能处理8层的目录，超过8层的部分，RRIP会自动将它们设置成ISO 9660兼容的格式。使用-D参数可关闭此功能。</span><br><span class="line">-f或-follow-links 忽略符号连接。</span><br><span class="line">-h 显示帮助。</span><br><span class="line">-hide&lt;目录或文件名&gt; 使指定的目录或文件在ISO 9660或Rock RidgeExtensions的系统中隐藏。</span><br><span class="line">-hide-joliet&lt;目录或文件名&gt; 使指定的目录或文件在Joliet系统中隐藏。</span><br><span class="line">-J或-joliet 使用Joliet格式的目录与文件名称。</span><br><span class="line">-l或-full-iso9660-filenames 使用ISO 9660 32字符长度的文件名。</span><br><span class="line">-L或-allow-leading-dots 允许文件名的第一个字符为句号。</span><br><span class="line">-log-file&lt;记录文件&gt; 在执行过程中若有错误信息，预设会显示在屏幕上。</span><br><span class="line">-m&lt;目录或文件名&gt;或-exclude&lt;目录或文件名&gt; 指定的目录或文件名将不会房入映像文件中。</span><br><span class="line">-M&lt;映像文件&gt;或-prev-session&lt;映像文件&gt; 与指定的映像文件合并。</span><br><span class="line">-N或-omit-version-number 省略ISO 9660文件中的版本信息。</span><br><span class="line">-o&lt;映像文件&gt;或-output&lt;映像文件&gt; 指定映像文件的名称。</span><br><span class="line">-p&lt;数据处理人&gt;或-preparer&lt;数据处理人&gt; 记录光盘的数据处理人。</span><br><span class="line">-print-size 显示预估的文件系统大小。</span><br><span class="line">-quiet 执行时不显示任何信息。</span><br><span class="line">-r或-rational-rock 使用Rock Ridge Extensions，并开放全部文件的读取权限。</span><br><span class="line">-R或-rock 使用Rock Ridge Extensions。</span><br><span class="line">-sysid&lt;系统ID&gt; 指定光盘的系统ID。</span><br><span class="line">-T或-translation-table 建立文件名的转换表，适用于不支持Rock Ridge Extensions的系统上。</span><br><span class="line">-v或-verbose 执行时显示详细的信息。</span><br><span class="line">-V&lt;光盘ID</span><br></pre></td></tr></table></figure>
<h4 id="UEFI-GPT引导基础"><a href="#UEFI-GPT引导基础" class="headerlink" title="UEFI+GPT引导基础"></a>UEFI+GPT引导基础</h4><p><strong>GPT及其优势</strong></p>
<p>GPT和MBR是两种不同的分区方案。目前在Windows下广泛采用的磁盘分区方案仍然是MBR分区结构，但不容怀疑GPT是今后的趋势。我们可将MBR磁盘分区结构用下图简单表示（Windows下基本磁盘、4个主分区）：</p>
<p><img src="/2021/05/24/linux系统启动小结/gpt1.png" alt="avatar"></p>
<p>为了方便计算机访问硬盘，把硬盘上的空间划分成许许多多的区块（英文叫sectors，即扇区），然后给每个区块分配一个地址，称为逻辑块地址（即LBA）。</p>
<p>在MBR磁盘的第一个扇区内保存着启动代码和硬盘分区表。启动代码的作用是指引计算机从活动分区引导启动操作系统（BIOS下启动操作系统的方式）；分区表的作用是记录硬盘的分区信息。在MBR中，分区表的大小是固定的，一共可容纳4个主分区信息。在MBR分区表中逻辑块地址采用32位二进制数表示，因此一共可表示2^32（2的32次方）个逻辑块地址。如果一个扇区大小为512字节，那么硬盘最大分区容量仅为2TB。</p>
<p>GPT磁盘分区结构可用下图简单表示（Windows下基本磁盘）：</p>
<p><img src="/2021/05/24/linux系统启动小结/gpt2.png" alt="avatar"></p>
<p>GPT分区结构<br>可以看到，在GTP磁盘的第一个数据块中同样有一个与MBR（主引导记录）类似的标记，叫做PMBR。PMBR的作用是，当使用不支持GPT的分区工具时，整个硬盘将显示为一个受保护的分区，以防止分区表及硬盘数据遭到破坏。UEFI并不从PMBR中获取GPT磁盘的分区信息，它有自己的分区表，即GPT分区表。</p>
<p>GPT的分区方案之所以比MBR更先进，是因为在GPT分区表头中可自定义分区数量的最大值，也就是说GPT分区表的大小不是固定的。在Windows中，微软设定GPT磁盘最大分区数量为128个。另外，GPT分区方案中逻辑块地址（LBA）采用64位二进制数表示，可以计算一下2^64是一个多么庞大的数据，以我们的需求来讲完全有理由认为这个大小约等于无限。除此之外，GPT分区方案在硬盘的末端还有一个备份分区表，保证了分区信息不容易丢失。</p>
<h4 id="安装系统启动过程"><a href="#安装系统启动过程" class="headerlink" title="安装系统启动过程"></a>安装系统启动过程</h4><p>以光盘安装操作系统为例，当我们安装系统时，它是怎么一步步读取光盘中的必要文件，从而实现系统的安装；不论是哪种安装方法，光盘、硬盘、网络等等，涉及的系统安装必要文件是一样的；</p>
<p>第一步：读取MBR： isolinux/boot.cat ###boot.cat的作用就相当于启动流程中的MBR的446字节效果</p>
<p>第二步: 读取isolinux/isolinux.bin ###isolinux.bin的作用等价于grub的第二阶段</p>
<p>第三步：加载配置文件： isolinux/isolinux.cfg ###这个文件就是启动菜单；自定义启动菜单可以修改此文件</p>
<p>第四步：根据配置文件定义调用内核文件</p>
<ul>
<li>加载内核： isolinuz/vmlinuz</li>
<li>向内核传递参数： append initrd=initrd.img</li>
</ul>
<p>第五步：装载根文件系统，并启动anaconda ###anaconda就是kickstart文件</p>
<p>默认启动GUI接口</p>
<p>若是显式指定使用GUI接口： 向内核传递text参数即可</p>
<p>(1)按tab键,在后面增加text ###tab进入的就是isolinux.cfg内容</p>
<p>(2)按ESC键： boot: linux text ###boot后面接label的内容，就进入相应的模式；如boot：rescue 当然如果是boot：linux rescue 进入的也是救援模式，因为linux和rescue之间就差一个rescue</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]#lsblk</span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sr0     11:0    1  3.7G  0 rom  /mnt</span><br><span class="line">sda      8:0    0  200G  0 disk </span><br><span class="line">├─sda1   8:1    0    1G  0 part /boot</span><br><span class="line">├─sda2   8:2    0 48.8G  0 part /</span><br><span class="line">├─sda3   8:3    0 29.3G  0 part /data</span><br><span class="line">├─sda4   8:4    0    1K  0 part </span><br><span class="line">└─sda5   8:5    0    2G  0 part [SWAP]</span><br><span class="line">[root@centos6 ~]#cd /mnt/</span><br><span class="line">[root@centos6 mnt]#ls</span><br><span class="line">CentOS_BuildTag  isolinux                  RPM-GPG-KEY-CentOS-Debug-6</span><br><span class="line">EFI              Packages                  RPM-GPG-KEY-CentOS-Security-6</span><br><span class="line">EULA             RELEASE-NOTES-en-US.html  RPM-GPG-KEY-CentOS-Testing-6</span><br><span class="line">GPL              repodata                  TRANS.TBL</span><br><span class="line">images           RPM-GPG-KEY-CentOS-6</span><br><span class="line">[root@centos6 mnt]#cd isolinux/</span><br><span class="line">[root@centos6 isolinux]#ls   ###此部分就是官方提供的光盘安装系统，提供的必要文件</span><br><span class="line">boot.cat  grub.conf   isolinux.bin  memtest     TRANS.TBL     vmlinuz</span><br><span class="line">boot.msg  initrd.img  isolinux.cfg  splash.jpg  vesamenu.c32</span><br><span class="line">[root@centos6 isolinux]#</span><br></pre></td></tr></table></figure>
<p><strong>系统引导文件分析—isolinux.cfg</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 isolinux]#cat isolinux.cfg</span><br><span class="line">default vesamenu.c32    ###启动菜单的样式</span><br><span class="line">#prompt 1</span><br><span class="line">timeout 600</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">display boot.msg   ####启动时的背景图片，以及下面设置了相关的菜单主题风格</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">menu background splash.jpg</span><br><span class="line">menu title Welcome to CentOS 6.10!</span><br><span class="line">menu color border 0 #ffffffff #00000000</span><br><span class="line">menu color sel 7 #ffffffff #ff000000</span><br><span class="line">menu color title 0 #ffffffff #00000000</span><br><span class="line">menu color tabmsg 0 #ffffffff #00000000</span><br><span class="line">menu color unsel 0 #ffffffff #00000000</span><br><span class="line">menu color hotsel 0 #ff000000 #ffffffff</span><br><span class="line">menu color hotkey 7 #ffffffff #ff000000</span><br><span class="line">menu color scrollbar 0 #ffffffff #00000000</span><br><span class="line">label linux   ###下面的五个label定义了启动系统可供选择的五个模式，对照图片可以一一对应</span><br><span class="line">  menu label ^Install or upgrade an existing system</span><br><span class="line">  menu default</span><br><span class="line">  kernel vmlinuz</span><br><span class="line">  append initrd=initrd.img</span><br><span class="line">label vesa</span><br><span class="line">  menu label Install system with ^basic video driver</span><br><span class="line">  kernel vmlinuz</span><br><span class="line">  append initrd=initrd.img nomodeset</span><br><span class="line">label rescue</span><br><span class="line">  menu label ^Rescue installed system</span><br><span class="line">  kernel vmlinuz</span><br><span class="line">  append initrd=initrd.img rescue</span><br><span class="line">label local</span><br><span class="line">  menu label Boot from ^local drive</span><br><span class="line">  localboot 0xffff</span><br><span class="line">label memtest86</span><br><span class="line">  menu label ^Memory test</span><br><span class="line">  kernel memtest</span><br><span class="line">  append -</span><br></pre></td></tr></table></figure>
<h4 id="CentOS-7-UEFI模式"><a href="#CentOS-7-UEFI模式" class="headerlink" title="CentOS 7 UEFI模式"></a>CentOS 7 UEFI模式</h4><ol>
<li>UEFI模式下EFI目录是必须的，legacy模式下EFI可以删除</li>
</ol>
<p><img src="/2021/05/24/linux系统启动小结/uefi1.png" alt="avatar"></p>
<ol start="2">
<li>ks引导文件在grub.cfg里修改</li>
</ol>
<p><img src="/2021/05/24/linux系统启动小结/uefi2.png" alt="avatar"></p>
<p><img src="/2021/05/24/linux系统启动小结/uefi3.png" alt="avatar"></p>
<ol start="3">
<li>efiboot.img文件是UEFI模式下必须的</li>
</ol>
<p><img src="/2021/05/24/linux系统启动小结/uefi4.png" alt="avatar"></p>
<ol start="4">
<li>UEFI模式需要有如下包支持</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub2-efi、grub2-tools、grub2-tools-extra、grub2-tools-minimal、grub2-common、shim、mokutil、efivar-libs、efibootmgr</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>legacy和UEFI模式ks文件的区别是磁盘分区，UEFI模式多了一个/boot/efi分区</li>
</ol>
<p><img src="/2021/05/24/linux系统启动小结/uefi5.png" alt="avatar"></p>
<ol start="6">
<li>UEFI打包方式和legacy模式不一样,命令如下</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">genisoimage -v -cache-inodes -joliet-long -R -J -T \</span><br><span class="line">-o /$iso_dir/CentOS-7_x86_64-UEFI.iso -b isolinux/isolinux.bin -c isolinux/boot.cat \</span><br><span class="line">-no-emul-boot -boot-load-size 4 -boot-info-table -eltorito-alt-boot -b images/efiboot.img -no-emul-boot -input-charset</span><br></pre></td></tr></table></figure>
<h4 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h4><ol>
<li><a href="https://blog.csdn.net/ZhangSong051052/article/details/80670970" target="_blank" rel="noopener">https://blog.csdn.net/ZhangSong051052/article/details/80670970</a></li>
<li><a href="https://www.cnblogs.com/klb561/p/9108712.html" target="_blank" rel="noopener">https://www.cnblogs.com/klb561/p/9108712.html</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/45791653" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/45791653</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/345519855" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/345519855</a></li>
<li><a href="https://developer.aliyun.com/article/523995" target="_blank" rel="noopener">https://developer.aliyun.com/article/523995</a></li>
<li><strong><a href="https://www.zhihu.com/question/21672895" target="_blank" rel="noopener">https://www.zhihu.com/question/21672895</a></strong></li>
<li><a href="https://blog.51cto.com/xlogin/1261632" target="_blank" rel="noopener">https://blog.51cto.com/xlogin/1261632</a></li>
<li><a href="https://yangfannie.com/1930.html" target="_blank" rel="noopener">https://yangfannie.com/1930.html</a></li>
<li><a href="https://www.iruanmi.com/what-is-gpt-and-what-is-uefi/" target="_blank" rel="noopener">https://www.iruanmi.com/what-is-gpt-and-what-is-uefi/</a></li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag"># linux</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/05/08/linux文件系统小结/" rel="next" title="linux文件系统小结">
                <i class="fa fa-chevron-left"></i> linux文件系统小结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/05/28/mysql锁小结/" rel="prev" title="mysql锁小结">
                mysql锁小结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">昨非</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">121</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#BIOS、EFI、UEFI"><span class="nav-number">1.</span> <span class="nav-text">BIOS、EFI、UEFI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#genisoimage、mkisofs"><span class="nav-number">2.</span> <span class="nav-text">genisoimage、mkisofs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UEFI-GPT引导基础"><span class="nav-number">3.</span> <span class="nav-text">UEFI+GPT引导基础</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装系统启动过程"><span class="nav-number">4.</span> <span class="nav-text">安装系统启动过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CentOS-7-UEFI模式"><span class="nav-number">5.</span> <span class="nav-text">CentOS 7 UEFI模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考文献"><span class="nav-number">6.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">昨非</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
